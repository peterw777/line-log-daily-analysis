name: Daily LINE Log Analysis

on:
  schedule:
    # æ¬å¤©å°ç£æ™‚é–“ 22:00 (UTC) = æ—©å¤ªæ™‚é–“ 10:00 (UTC+8)
    - cron: '0 22 * * *'  
  
  workflow_dispatch:  # å…è®¸æ‰‹å‹•è§¹è¯‹
    inputs:
      analysis_date:
        description: 'åˆ†ææ—¥æœŸ (YYYY-MM-DD)ï¼Œç•«è¯ç©ºåˆ™ä½¿ç”¨ä»Šå¤©'
        required: false
        type: string

jobs:
  run-analysis:
    runs-on: ubuntu-latest
    
    steps:
      - name: âœ… Execute Recipe
        run: |
          ANALYSIS_DATE="${{ inputs.analysis_date }}"
          
          # å¦‚æœæ²¡æœ‰æŒ‡å®šæ—¥æœŸ¼Œä½¿ç”¨ä»Šå¤©
          if [ -z "$ANALYSIS_DATE" ]; then
            ANALYSIS_DATE=""
          fi
          
          echo "ğŸ“… é€šè¡Œ Composio Recipe API.â€¦"
          echo "é‡‡æ”¹è¨­åˆ¥: $ANALYSIS_DATE"
          
          RESPONSE=$(curl -X POST \
            "https://api.composio.dev/api/v1/recipes/rcp_EuvREySaVZ-r/execute" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.COMPOSIO_API_KEY }}" \
            -s -w "\nHTTP Status: %{http_code}" \
            -d '{
              "spreadsheet_id": "123gBvBY9iTaC2Ym1GDbixjfYKJmIwAL0bV9U86bEc-c",
              "sheet_name": "logs",
              "recipient_email": "peterw@stu.edu.tw",
              "analysis_date": "'"$ANALYSIS_DATE"'"
            }')
          
          echo ""
          echo "ğŸ“§ API é›æ‡”å›å‚³:"
          echo "$RESPONSE"
          
          # æª¢æŸ¥æ˜¯å¦æˆåŠŸ
          if echo "$RESPONSE" | grep -q "HTTP Status: 200"; then
            echo "â˜…ï¸ é€šè¡ŒæˆåŠŸ!"
            exit 0
          else
            echo "âŒï¸ é€šè¿‡å¤±èµ§"
            exit 1
          fi
